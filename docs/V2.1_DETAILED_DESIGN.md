# AI Platform v2.1 详细设计

**版本**: 2.1.0  
**日期**: 2026-02-09  
**状态**: 设计中

---

## 一、Feature Store (特征存储)

### 1.1 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                    Feature Store                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ Online Store│  │Offline Store│  │Materialized │        │
│  │  (Redis)   │  │ (PostgreSQL)│  │   View     │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐  │
│  │              Feature Registry (PostgreSQL)            │  │
│  │  - Feature Groups                                    │  │
│  │  - Feature Views                                    │  │
│  │  - Metadata                                        │  │
│  └─────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ Ingestion   │  │   Serving   │  │ Monitoring │        │
│  │   API       │  │     API     │  │     API     │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 数据模型

```sql
-- Feature Groups表
CREATE TABLE feature_groups (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    owner_id UUID REFERENCES users(id),
    source_type VARCHAR(50),  -- 'batch', 'stream'
    source_uri TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Features表
CREATE TABLE features (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    feature_group_id UUID REFERENCES feature_groups(id),
    name VARCHAR(255) NOT NULL,
    dtype VARCHAR(50) NOT NULL,  -- 'int32', 'float64', 'string', 'bool'
    description TEXT,
    version INT DEFAULT 1,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Feature Materializations表
CREATE TABLE materializations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    feature_group_id UUID REFERENCES feature_groups(id),
    storage_type VARCHAR(50),  -- 'online', 'offline'
    schedule VARCHAR(100),
    last_run TIMESTAMP,
    status VARCHAR(50),
    created_at TIMESTAMP DEFAULT NOW()
);

-- Feature Values表 (在线特征)
CREATE TABLE feature_values (
    entity_id VARCHAR(255),
    feature_group_id UUID REFERENCES feature_groups(id),
    feature_name VARCHAR(255),
    value JSONB,
    event_time TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    PRIMARY KEY (entity_id, feature_group_id, feature_name, event_time)
);
```

### 1.3 API设计

| 方法 | 端点 | 说明 |
|------|------|------|
| POST | `/api/v2/feature-store/groups` | 创建特征组 |
| GET | `/api/v2/feature-store/groups` | 列出特征组 |
| GET | `/api/v2/feature-store/groups/{id}` | 获取特征组详情 |
| POST | `/api/v2/feature-store/groups/{id}/features` | 添加特征 |
| POST | `/api/v2/feature-store/ingest` | 写入特征 |
| GET | `/api/v2/feature-store/online` | 在线特征查询 |
| POST | `/api/v2/feature-store/materialize` | 物化特征 |

### 1.4 模块结构

```
backend/feature_store/
├── __init__.py
├── store.py              # FeatureStore类
├── registry.py          # FeatureRegistry类
├── ingestion.py         # 特征摄入
├── serving.py          # 特征服务
├── materialization.py   # 特征物化
└── monitoring.py       # 特征监控
```

---

## 二、Model Registry (模型注册中心)

### 2.1 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                   Model Registry                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐    │
│  │              Model Versions (PostgreSQL)           │    │
│  │  - Registered Models                                │    │
│  │  - Model Versions                                  │    │
│  │  - Model Stages                                    │    │
│  └─────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Stages    │  │   Aliases   │  │  Transitions │        │
│  │  Management │  │  Management │  │   History   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐  │
│  │                   Model Storage                      │  │
│  │  - Local filesystem                                │  │
│  │  - S3/GCS (future)                                │  │
│  │  - Model versioning                                 │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 数据模型

```sql
-- Registered Models表
CREATE TABLE registered_models (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    project_id UUID REFERENCES projects(id),
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(name)
);

-- Model Versions表
CREATE TABLE model_versions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    model_id UUID REFERENCES registered_models(id),
    version INT NOT NULL,
    model_uri TEXT NOT NULL,
    run_id UUID,  -- 关联实验run
    status VARCHAR(50),  -- 'pending', 'ready', 'failed', 'archived'
    current_stage VARCHAR(50),  -- 'None', 'Staging', 'Production', 'Archived'
    description TEXT,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(model_id, version)
);

-- Model Stages表
CREATE TABLE model_stages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    model_version_id UUID REFERENCES model_versions(id),
    stage VARCHAR(50) NOT NULL,
    transitioned_by UUID REFERENCES users(id),
    transitioned_at TIMESTAMP DEFAULT NOW(),
    comment TEXT
);

-- Model Aliases表
CREATE TABLE model_aliases (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    model_id UUID REFERENCES registered_models(id),
    alias VARCHAR(255) NOT NULL,
    version INT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(model_id, alias)
);
```

### 2.3 API设计

| 方法 | 端点 | 说明 |
|------|------|------|
| POST | `/api/v2/models/register` | 注册模型 |
| GET | `/api/v2/models` | 列出模型 |
| GET | `/api/v2/models/{name}` | 获取模型详情 |
| POST | `/api/v2/models/{name}/versions` | 创建版本 |
| GET | `/api/v2/models/{name}/versions/{version}` | 获取版本详情 |
| PUT | `/api/v2/models/{name}/versions/{version}/stage` | 切换阶段 |
| POST | `/api/v2/models/{name}/alias` | 设置别名 |
| GET | `/api/v2/models/{name}/latest` | 获取最新版本 |

### 2.4 模块结构

```
backend/models/
├── __init__.py
├── registry.py           # ModelRegistry类
├── versioning.py        # ModelVersioning类
├── stages.py            # Stage管理
├── aliases.py           # Alias管理
├── storage.py           # ModelStorage类
└── lineage.py           # ModelLineage类
```

---

## 三、Model Lineage (模型血缘)

### 3.1 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                   Model Lineage                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│    ┌──────────┐     ┌──────────┐     ┌──────────┐        │
│    │  Dataset │────▶│ Training │────▶│  Model   │        │
│    └──────────┘     │   Run    │     └──────────┘        │
│                     └──────────┘          │                   │
│                          │              │                   │
│                          ▼              ▼                   │
│                     ┌──────────┐     ┌──────────┐        │
│                     │Artifacts │────▶│Version   │        │
│                     └──────────┘     └──────────┘        │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  Lineage Graph (DAG)                                       │
│  - Nodes: Datasets, Runs, Models, Artifacts               │
│  - Edges: Data Flow, Execution Flow                        │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 数据模型

```sql
-- Lineage Nodes表
CREATE TABLE lineage_nodes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    node_type VARCHAR(50) NOT NULL,  -- 'dataset', 'run', 'model', 'artifact'
    node_id VARCHAR(255) NOT NULL,  -- 外部ID
    name VARCHAR(255),
    metadata JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(node_type, node_id)
);

-- Lineage Edges表
CREATE TABLE lineage_edges (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    source_node_id UUID REFERENCES lineage_nodes(id),
    target_node_id UUID REFERENCES lineage_nodes(id),
    edge_type VARCHAR(50),  -- 'data_flow', 'execution_flow'
    metadata JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Execution Runs表
CREATE TABLE execution_runs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    run_id VARCHAR(255) NOT NULL,
    experiment_id UUID,
    status VARCHAR(50),
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 3.3 API设计

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/api/v2/lineage/{node_type}/{node_id}` | 获取节点血缘 |
| GET | `/api/v2/lineage/graph` | 获取血缘图 |
| POST | `/api/v2/lineage/node` | 创建节点 |
| POST | `/api/v2/lineage/edge` | 创建边 |
| GET | `/api/v2/lineage/runs/{run_id}` | 获取运行血缘 |

### 3.4 模块结构

```
backend/lineage/
├── __init__.py
├── graph.py              # LineageGraph类
├── nodes.py              # Node管理
├── edges.py              # Edge管理
├── tracking.py           # LineageTracking类
└── visualization.py     # 可视化支持
```

---

## 四、Notebooks集成

### 4.1 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                  Notebooks集成                             │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐  │
│  │              Notebook Manager                        │  │
│  │  - Create/Edit/Delete notebooks                    │  │
│  │  - Version control                                  │  │
│  │  - Share & Collaborate                             │  │
│  └─────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Kernel    │  │   Cells     │  │  Outputs    │        │
│  │  Manager    │  │  Execution  │  │  Store      │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐  │
│  │              Integration API                          │  │
│  │  - Experiment tracking in notebooks                 │  │
│  │  - Model logging                                    │  │
│  │  - Dataset access                                    │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 API设计

| 方法 | 端点 | 说明 |
|------|------|------|
| POST | `/api/v2/notebooks` | 创建notebook |
| GET | `/api/v2/notebooks` | 列出notebooks |
| GET | `/api/v2/notebooks/{id}` | 获取notebook |
| PUT | `/api/v2/notebooks/{id}` | 更新notebook |
| POST | `/api/v2/notebooks/{id}/execute` | 执行cell |
| POST | `/api/v2/notebooks/{id}/share` | 分享notebook |

### 4.3 模块结构

```
backend/notebooks/
├── __init__.py
├── manager.py            # NotebookManager类
├── kernel.py            # Kernel管理
├── execution.py         # Cell执行
├── storage.py           # Notebook存储
└── integration.py       # ML集成
```

---

## 五、数据质量增强

### 5.1 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                  Data Quality增强                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐  │
│  │              Quality Rules Engine                     │  │
│  │  - Schema validation                                │  │
│  │  - Custom rules                                     │  │
│  │  - Statistical checks                               │  │
│  └─────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  Expectation│  │   Metrics   │  │  Reports     │        │
│  │   Suite     │  │  Calculator  │  │  Generator   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐  │
│  │              Integration                             │  │
│  │  - Dataset validation                               │  │
│  │  - Pipeline validation                              │  │
│  │  - Continuous monitoring                            │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 API设计

| 方法 | 端点 | 说明 |
|------|------|------|
| POST | `/api/v2/data/quality/rules` | 创建质量规则 |
| GET | `/api/v2/data/quality/rules` | 列出规则 |
| POST | `/api/v2/data/quality/validate` | 验证数据集 |
| GET | `/api/v2/data/quality/reports/{id}` | 获取报告 |
| POST | `/api/v2/data/quality/schedule` | 设置定时检查 |

### 5.3 模块结构

```
backend/quality/
├── __init__.py
├── rules.py              # QualityRulesEngine
├── suite.py             # ExpectationSuite
├── metrics.py           # QualityMetrics
├── report.py            # QualityReports
└── scheduler.py         # QualityScheduler
```

---

## 六、实施计划

### 6.1 Week 1-3: Feature Store

| 天数 | 任务 | 交付物 |
|------|------|--------|
| Day 1-5 | 数据库设计 + 基础架构 | `backend/feature_store/` |
| Day 6-10 | Ingestion API | 特征摄入接口 |
| Day 11-15 | Serving API | 特征服务接口 |

### 6.2 Week 4-5: Model Registry

| 天数 | 任务 | 交付物 |
|------|------|--------|
| Day 1-5 | 注册 + 版本管理 | `backend/models/registry.py` |
| Day 6-10 | Stage管理 | 阶段切换功能 |

### 6.3 Week 6: Model Lineage

| 天数 | 任务 | 交付物 |
|------|------|--------|
| Day 1-5 | Lineage Graph | `backend/lineage/` |
| Day 6-10 | API + 可视化 | 血缘查询API |

### 6.4 Week 7: 数据质量增强

| 天数 | 任务 | 交付物 |
|------|------|--------|
| Day 1-5 | Rules Engine | `backend/quality/` |
| Day 6-7 | Reports | 质量报告 |

### 6.5 Week 8-10: Notebooks集成

| 天数 | 任务 | 交付物 |
|------|------|--------|
| Day 1-5 | Manager + Kernel | `backend/notebooks/` |
| Day 6-10 | Integration | ML集成 |

---

## 七、依赖

### 7.1 Python依赖

```txt
# requirements.txt (新增)
feast>=0.40.0              # Feature Store参考
great-expectations>=0.18.0  # 数据质量
ipykernel>=6.25.0          # Notebook kernel
nbformat>=5.9.0            # Notebook格式
jinja2>=3.1.0              # 模板渲染
```

### 7.2 前端依赖

```txt
# frontend/package.json (新增)
"@ant-design/charts": "^1.4.0",  # 血缘图可视化
"@ant-design/pro-components": "^2.6.0"  # Notebook编辑器
```

---

## 八、风险

### 8.1 技术风险

| 风险 | 影响 | 缓解 |
|------|------|------|
| Feature Store复杂度 | 高 | 先实现离线特征 |
| Notebook安全 | 中 | 沙箱隔离 |
| Lineage性能 | 中 | 增量更新 |

### 8.2 进度风险

| 风险 | 影响 | 缓解 |
|------|------|------|
| Feature Store超预期 | 3天 | MVP优先 |
| 测试时间不足 | 2天 | 自动化测试 |

---

## 九、验收标准

### 9.1 功能验收

- [ ] Feature Store支持离线/在线特征
- [ ] Model Registry支持阶段切换
- [ ] Model Lineage支持完整血缘追踪
- [ ] Notebooks支持执行和分享
- [ ] 数据质量支持自定义规则

### 9.2 性能验收

- [ ] 特征查询 < 100ms
- [ ] 血缘查询 < 500ms
- [ ] Notebook启动 < 5s

---

**文档版本**: 2.1.0  
**创建日期**: 2026-02-09  
**作者**: AI Development Team
