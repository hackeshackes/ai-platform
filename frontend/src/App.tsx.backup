import { Routes, Route, useNavigate, useLocation, Navigate } from 'react-router-dom'
import { Layout as ALayout, Menu } from 'antd'
import { useLang } from './locales'

// é¡µé¢ç»„ä»¶
import Dashboard from './pages/Dashboard'
import Projects from './pages/Projects'
import Experiments from './pages/Experiments'
import Tasks from './pages/Tasks'
import Training from './pages/Training'
import Inference from './pages/Inference'
import Datasets from './pages/Datasets'
import Login from './pages/Login'

// v2 é¡µé¢
import { AutoMLPage } from './pages/v2/AutoML'
import { FeatureStorePage } from './pages/v2/FeatureStore'
import { NotebooksPage } from './pages/v2/Notebooks'
import { RAGPage } from './pages/v2/RAG'

// v8 é¡µé¢
import { AgentFactoryPage } from './pages/v8/AgentFactory'
import { KnowledgeGraphPage } from './pages/v8/KnowledgeGraph'
import { EmbodiedAIPage } from './pages/v8/EmbodiedAI'
import { AgentCollaborationPage } from './pages/v8/AgentCollaboration'
import { SecurityPage } from './pages/v8/Security'
import { PluginMarketplacePage } from './pages/v8/PluginMarketplace'

// è·¯ç”±å®ˆå«
const PrivateRoute = ({ children }: { children: React.ReactNode }) => {
  const token = localStorage.getItem('access_token')
  if (!token) {
    return <Navigate to="/login" replace />
  }
  return <>{children}</>
}

const { Sider, Content, Header } = ALayout

export default function App() {
  const { t, lang, setLang } = useLang()
  const navigate = useNavigate()
  const location = useLocation()
  
  const menuItems = [
    { key: '/dashboard', label: t('nav.dashboard') },
    { key: '/projects', label: t('nav.projects') },
    { key: '/experiments', label: t('nav.experiments') },
    { key: '/tasks', label: t('nav.tasks') },
    { key: '/training', label: t('nav.training') },
    { key: '/inference', label: t('nav.inference') },
    { key: '/datasets', label: t('nav.datasets') },
    { type: 'divider' },
    { key: '/automl', label: 'AutoML' },
    { key: '/feature-store', label: 'Feature Store' },
    { key: '/notebooks', label: 'Notebooks' },
    { key: '/rag', label: 'RAG' },
    { type: 'divider' },
    { key: '/agent-factory', label: 'ðŸ¤– Agentå·¥åŽ‚' },
    { key: '/knowledge-graph', label: 'ðŸ§  çŸ¥è¯†å›¾è°±' },
    { key: '/embodied-ai', label: 'ðŸ¦¾ å…·èº«AI' },
    { key: '/collaboration', label: 'ðŸ‘¥ Agentåä½œ' },
    { key: '/security', label: 'ðŸ›¡ï¸ å®‰å…¨ä¸­å¿ƒ' },
    { key: '/plugin-marketplace', label: 'ðŸ§© Pluginå¸‚åœº' },
  ]

  const selectedKey = menuItems.find(item => item.key && location.pathname.startsWith(item.key))?.key || '/dashboard'

  return (
    <ALayout style={{ minHeight: '100vh' }}>
      <Sider collapsible theme="dark" onCollapse={(collapsed) => collapsed}>
        <div className="logo" style={{ height: 32, margin: 16, color: '#fff', fontSize: 18, fontWeight: 'bold', textAlign: 'center', lineHeight: '32px' }}>
          AI Platform
        </div>
        <Menu 
          theme="dark" 
          mode="inline" 
          selectedKeys={[selectedKey]} 
          items={menuItems}
          onClick={({ key }) => navigate(key)}
          style={{ borderRight: 0 }}
        />
      </Sider>
      <ALayout>
        <Header style={{ background: '#fff', padding: '0 24px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', borderBottom: '1px solid #f0f0f0' }}>
          <span style={{ fontSize: 18, fontWeight: 500 }}>{t('app.title')}</span>
          <span 
            style={{ cursor: 'pointer', padding: '8px 16px', borderRadius: 4, background: '#f5f5f5', userSelect: 'none' }}
            onClick={() => setLang(lang === 'zh' ? 'en' : 'zh')}
          >
            {lang === 'zh' ? 'ðŸ‡¨ðŸ‡³ ä¸­æ–‡' : 'ðŸ‡ºðŸ‡¸ English'}
          </span>
        </Header>
        <Content style={{ margin: 24 }}>
          <Routes>
            <Route path="/login" element={<Login />} />
            <Route path="/" element={<PrivateRoute><Dashboard /></PrivateRoute>} />
            <Route path="/dashboard" element={<PrivateRoute><Dashboard /></PrivateRoute>} />
            <Route path="/projects" element={<PrivateRoute><Projects /></PrivateRoute>} />
            <Route path="/experiments" element={<PrivateRoute><Experiments /></PrivateRoute>} />
            <Route path="/tasks" element={<PrivateRoute><Tasks /></PrivateRoute>} />
            <Route path="/training" element={<PrivateRoute><Training /></PrivateRoute>} />
            <Route path="/inference" element={<PrivateRoute><Inference /></PrivateRoute>} />
            <Route path="/datasets" element={<PrivateRoute><Datasets /></PrivateRoute>} />
            
            {/* v2 Pages */}
            <Route path="/automl" element={<PrivateRoute><AutoMLPage /></PrivateRoute>} />
            <Route path="/feature-store" element={<PrivateRoute><FeatureStorePage /></PrivateRoute>} />
            <Route path="/notebooks" element={<PrivateRoute><NotebooksPage /></PrivateRoute>} />
            <Route path="/rag" element={<PrivateRoute><RAGPage /></PrivateRoute>} />
            
            {/* v8 Pages */}
            <Route path="/agent-factory" element={<PrivateRoute><AgentFactoryPage /></PrivateRoute>} />
            <Route path="/knowledge-graph" element={<PrivateRoute><KnowledgeGraphPage /></PrivateRoute>} />
            <Route path="/embodied-ai" element={<PrivateRoute><EmbodiedAIPage /></PrivateRoute>} />
            <Route path="/collaboration" element={<PrivateRoute><AgentCollaborationPage /></PrivateRoute>} />
            <Route path="/security" element={<PrivateRoute><SecurityPage /></PrivateRoute>} />
            <Route path="/plugin-marketplace" element={<PrivateRoute><PluginMarketplacePage /></PrivateRoute>} />
          </Routes>
        </Content>
      </ALayout>
    </ALayout>
  )
}
